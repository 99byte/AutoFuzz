# AutoFuzz 开发文档

## 项目架构

### 技术栈

- **前端**: Next.js 14 + TypeScript + TailwindCSS + shadcn/ui
- **后端**: Next.js API Routes
- **数据库**: SQLite + Prisma ORM
- **AI**: 智谱AI GLM-4 (通过OpenAI兼容API）
- **Fuzz引擎**: Open-AutoGLM (Python）
- **实时通信**: Server-Sent Events (SSE）

---

## 目录结构

```
autofuzz/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── api/                 # API Routes
│   │   └── (dashboard)/         # 仪表板页面
│   ├── components/              # React组件
│   │   ├── ui/                  # shadcn/ui组件
│   │   └── *.tsx               # 自定义组件
│   ├── lib/                     # 核心库
│   │   ├── prisma.ts           # Prisma客户端
│   │   ├── ai.ts               # 智谱LLM集成
│   │   ├── autoglm.ts          # AutoGLM封装
│   │   ├── adb.ts              # ADB操作
│   │   ├── fuzz-runner.ts      # Fuzz执行器
│   │   └── stream.ts           # SSE流管理
│   ├── hooks/                  # React Hooks
│   └── types/                 # TypeScript类型
├── scripts/                    # 脚本
│   ├── setup.sh               # 初始化脚本
│   ├── fuzz_worker.py         # Python工作脚本
│   └── seed-db.ts            # 数据库种子
├── vendor/Open-AutoGLM/        # Git Submodule
├── prisma/                    # Prisma配置
└── docs/                      # 文档
```

---

## 核心模块说明

### 1. ADBMonitor (`src/lib/adb.ts`)

负责与Android设备通信和崩溃检测。

**主要方法：**
- `getDevices()` - 获取已连接的设备列表
- `isAppRunning()` - 检查应用是否在运行
- `launchApp()` - 启动应用
- `forceStopApp()` - 强制停止应用
- `getLogcat()` - 获取日志
- `detectCrash()` - 检测崩溃
- `startMonitoring()` - 启动崩溃监控
- `stopMonitoring()` - 停止崩溃监控

**崩溃检测逻辑：**
```typescript
// Native崩溃
/FATAL EXCEPTION.*?\n.*?backtrace:([\s\S]*?)(?=\n\n|$)/i

// Java异常
/AndroidRuntime.*?FATAL EXCEPTION.*?\n([\s\S]*?)(?=\n\n|$)/i

// ANR
/ANR in.*?${packageName}/i

// 进程死亡
通过 `pidof` 命令检查进程是否存在
```

### 2. TestCaseGenerator (`src/lib/ai.ts`)

使用智谱AI生成测试用例。

**主要方法：**
- `generateUITestCases()` - 生成UI测试用例
- `analyzeTestResults()` - 分析测试结果

**Prompt模板：**
- System Prompt：定义AI的角色和输出格式
- User Prompt：传入应用信息和测试要求

**输出格式：**
```json
{
  "testCases": [
    {
      "id": "唯一标识",
      "description": "测试用例描述",
      "category": "功能类别",
      "actions": [
        {
          "action": "Tap",
          "description": "点击描述",
          "params": { "element": "元素" }
        }
      ],
      "expectedBehavior": "预期行为",
      "crashProbability": "high"
    }
  ]
}
```

### 3. AutoGLMFuzzer (`src/lib/autoglm.ts`)

封装AutoGLM的调用。

**主要方法：**
- `executeAction()` - 执行单个动作
- `executeFuzzSequence()` - 执行动作序列
- `getScreenshot()` - 获取截图

**动作类型映射：**
- Launch → `adb shell monkey -p <app> -c android.intent.category.LAUNCHER 1`
- Tap → `adb shell input tap <x> <y>`
- Type → `adb shell input text "<text>"`
- Swipe → `adb shell input swipe <x1> <y1> <x2> <y2>`
- Back → `adb shell input keyevent KEYCODE_BACK`
- Home → `adb shell input keyevent KEYCODE_HOME`

### 4. FuzzTaskRunner (`src/lib/fuzz-runner.ts`)

核心执行器，协调所有模块。

**执行流程：**
```
1. 更新任务状态 → running
2. 生成测试用例 (TestCaseGenerator）
3. 启动崩溃监控 (ADBMonitor）
4. 依次执行测试用例 (AutoGLMFuzzer）
5. 保存执行结果到数据库
6. 实时推送进度 (SSE）
7. 生成测试摘要
8. 更新任务状态 → completed
```

### 5. SSE Stream (`src/lib/stream.ts`)

管理Server-Sent Events连接。

**数据结构：**
```typescript
const taskStreams = new Map<string, Set<Readable>>();
```

**事件类型：**
- `task_started` - 任务开始
- `test_cases_generated` - 测试用例生成完成
- `test_case_started` - 开始执行测试用例
- `action_completed` - 动作完成
- `crash_detected` - 检测到崩溃
- `task_completed` - 任务完成
- `task_failed` - 任务失败

---

## 数据库模型

### FuzzTask
测试任务主表。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 任务ID |
| name | String | 任务名称 |
| targetApp | String | 应用包名 |
| appDescription | String? | 应用描述 |
| testCases | String | JSON字符串 |
| testConfig | String | JSON字符串 |
| status | String | 任务状态 |
| createdAt | DateTime | 创建时间 |
| startedAt | DateTime? | 开始时间 |
| completedAt | DateTime? | 完成时间 |

### TestExecution
测试执行记录。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 执行ID |
| taskId | String | 关联任务 |
| testCaseIndex | Int | 测试用例索引 |
| status | String | 执行状态 |
| startTime | DateTime | 开始时间 |
| endTime | DateTime? | 结束时间 |
| duration | Int? | 持续时间(ms) |
| logs | String? | 执行日志 |

### CrashReport
崩溃报告。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 崩溃ID |
| executionId | String | 关联执行 |
| taskId | String | 关联任务 |
| crashType | String | 崩溃类型 |
| stackTrace | String? | 堆栈跟踪 |
| package | String | 应用包名 |
| severity | String | 严重程度 |
| createdAt | DateTime | 崩溃时间 |

---

## 开发新功能

### 1. 添加新的操作类型

**步骤：**

1. 在 `src/types/autoglm.ts` 添加新类型：

```typescript
export type ActionType = 
  | 'Launch' 
  | 'Tap' 
  | // ... 现有类型
  | 'DoubleTap';  // 新类型
```

2. 在 `src/lib/autoglm.ts` 添加实现：

```typescript
case 'DoubleTap':
  command = `adb shell input tap ${x} ${y}`;
  await new Promise(r => setTimeout(r, 100));
  await execAsync(command);
  break;
```

3. 在AI prompt中添加描述（`src/lib/ai.ts`）

### 2. 添加新的崩溃检测规则

在 `src/lib/adb.ts` 的 `detectCrash()` 方法中添加：

```typescript
const customCrashMatch = logcat.match(/自定义崩溃模式/i);
if (customCrashMatch) {
  return {
    type: 'custom_crash',
    timestamp: new Date(),
    package: this.packageName,
    logcat: logcat.slice(-5000)
  };
}
```

### 3. 添加新的统计指标

1. 在 `prisma/schema.prisma` 添加字段：

```prisma
model TestResult {
  // ... 现有字段
  coverageRate    Float?  # 覆盖率
  memoryLeaks     Int?    # 内存泄漏数
}
```

2. 运行迁移：

```bash
npx prisma migrate dev --name add_coverage
```

3. 在 `src/lib/fuzz-runner.ts` 更新逻辑

---

## 测试

### 单元测试

```bash
npm test
```

### 手动测试流程

1. 创建测试任务
2. 启动测试
3. 观察实时日志
4. 检查数据库记录
5. 验证崩溃检测

### 调试技巧

**查看ADB日志：**
```bash
adb logcat -c  # 清空日志
adb logcat | grep <package-name>  # 过滤日志
```

**监控进程：**
```bash
adb shell ps | grep <package-name>
```

**查看崩溃日志：**
```bash
adb logcat -d | grep -A 20 "FATAL"
```

---

## 性能优化

### 1. 数据库优化

```typescript
// 使用索引
@@index([status])
@@index([createdAt])

// 批量操作
await prisma.testExecution.createMany({
  data: [...]
});
```

### 2. API响应优化

```typescript
// 使用流式响应
import { streamToClient } from '@/lib/stream';
streamToClient(taskId, { type: 'progress', value: 50 });
```

### 3. 前端优化

```typescript
// 使用防抖
const debouncedFetch = useMemo(() => 
  debounce(fetchTasks, 500), []
);

// 使用虚拟滚动
import { useVirtualizer } from '@tanstack/react-virtual';
```

---

## 部署

### 构建生产版本

```bash
npm run build
npm start
```

### 环境变量

生产环境需要配置：
- `DATABASE_URL` - 数据库连接
- `ZHIPU_API_KEY` - 智谱API密钥
- `AUTOGLM_BASE_URL` - 模型服务地址
- `NEXT_PUBLIC_APP_URL` - 应用URL

---

## 故障排查

### 问题：Python模块导入失败

```bash
# 检查虚拟环境
source autoglm-env/bin/activate
python -c "import phone_agent; print('OK')"

# 重新安装
pip install -e ./vendor/Open-AutoGLM
```

### 问题：SSE连接断开

检查浏览器控制台，确保：
- 没有网络错误
- EventSource没有报错
- 服务器正在运行

### 问题：数据库迁移失败

```bash
# 重置数据库
rm -f prisma/dev.db
npx prisma migrate dev --name init
```

---

## 贡献指南

欢迎提交Issue和Pull Request！

**代码规范：**
- 使用TypeScript类型
- 遵循ESLint规则
- 编写清晰的注释

**提交规范：**
```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
refactor: 重构代码
test: 添加测试
```

---

## 许可证

MIT License

---

## 联系方式

如有问题，请提交Issue或联系维护者。
